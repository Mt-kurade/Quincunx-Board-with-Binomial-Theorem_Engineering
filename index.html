<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quincunx Board â€” Aesthetic Simulation</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
    :root{
    --bg-start:#0f172a; /* slate-950 */
    --bg-end:#0b1220; /* deep indigo */
    }
    html,body{height:100%;}
    body{
        font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
        margin:0;
        background: linear-gradient(180deg,var(--bg-start) 0%, #071029 40%, #071227 100%);
        -webkit-font-smoothing:antialiased;
        -moz-osx-font-smoothing:grayscale;
        color: #e6eef8;
    }
    
    
    /* Card and layout */
    .card{
        backdrop-filter: blur(6px) saturate(120%);
        background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
        border: 1px solid rgba(255,255,255,0.04);
        box-shadow: 0 10px 30px rgba(2,6,23,0.6);
        border-radius: 16px;
    }
    
    
    /* Canvas responsive sizing, keep internal resolution fixed for coordinates */
    .canvas-wrap{
        width:100%;
        max-width:760px;
        margin:0 auto;
        display:flex;
        justify-content:center;
        padding:18px;
    }
    canvas{width:100%; height:auto; border-radius:12px; display:block}
    
    
    /* Nice range appearance (subtle) */
    input[type=range]{
        -webkit-appearance:none; height:6px; border-radius:999px; background:linear-gradient(90deg,#334155,#06b6d4);
    }
    input[type=range]::-webkit-slider-thumb{ -webkit-appearance:none; width:18px; height:18px; border-radius:999px; background:white; box-shadow: 0 3px 8px rgba(2,6,23,0.5); border:2px solid rgba(0,0,0,0.12)}
    
    
    /* small helper */
    .muted{color:#9fb0c8}
    .pill{padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.03)}
    
    
    /* tiny animation for header */
    .logo-dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(90deg,#f97316,#ef4444);box-shadow:0 6px 18px rgba(239,68,68,0.25);display:inline-block;margin-right:8px}
    </style>
</head>
<body>
    <div class="min-h-screen flex items-center justify-center p-6">
    <div class="canvas-wrap">
    <canvas id="simCanvas" width="760" height="820" class="shadow-inner"></canvas>
    </div>
    
    
    <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
    <div class="flex gap-2 items-center">
    <button id="toggleBtn" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-gradient-to-r from-blue-500 to-indigo-600 shadow-lg font-semibold">
    <svg id="playSvg" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="white"><path d="M6.5 5.5v9l7-4.5-7-4.5z" /></svg>
    <span id="toggleText">Start</span>
    </button>
    
    
    <button id="singleDrop" class="px-3 py-2 pill font-medium">Drop 1</button>
    <button id="resetBtn2" class="px-3 py-2 pill font-medium">Reset</button>
    </div>
    
    
    <div class="flex justify-end items-center gap-3">
    <div class="text-right muted text-sm">
    <div>Total balls: <span id="totalCount" class="font-bold">0</span></div>
    <div class="mt-1">Theory: <span id="theoryOn" class="pill">ON</span></div>
    </div>
    </div>
    </div>
    
    
    </div>
    </div>
    
    
    <hr class="my-5 border-transparent" />
    
    
    <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
    <div>
    <label class="text-xs muted">Speed</label>
    <input id="speedRange" type="range" min="0.25" max="4" step="0.25" value="1">
    <div class="text-sm mt-1">x<span id="speedVal">1</span></div>
    </div>
    
    
    <div>
    <label class="text-xs muted">Rows</label>
    <input id="rowsRange" type="range" min="6" max="16" step="1" value="12">
    <div class="text-sm mt-1"><span id="rowsVal">12</span> rows</div>
    </div>
    
    
    <div>
    <label class="text-xs muted">Probability (p)</label>
    <input id="pRange" type="range" min="0.1" max="0.9" step="0.01" value="0.5">
    <div class="text-sm mt-1">p = <span id="pVal">0.50</span></div>
    </div>
    
    
    <div>
    <label class="text-xs muted">Drop rate</label>
    <input id="rateRange" type="range" min="1" max="60" step="1" value="8">
    <div class="text-sm mt-1"><span id="rateVal">8</span> balls / sec</div>
    </div>
    </div>
    
    
    </div>
    </div>
<script>
const newBins = bins.slice();
const remaining = [];
for(const b of balls){ b.update(dt); if(!b.moving && b.binIndex>=0) newBins[b.binIndex]++; else remaining.push(b); }
balls = remaining; bins = newBins;


// draw
ctx.clearRect(0,0,canvas.width,canvas.height);
drawBackground(); drawPegs(); drawBallsList(); drawBins(bins); drawFormulaText();


document.getElementById('totalCount').textContent = bins.reduce((a,b)=>a+b,0);


if(isRunning) animationId = requestAnimationFrame(animate); else animationId = null;
}


// --- Controls & events ---
document.getElementById('toggleBtn').addEventListener('click', ()=>{
isRunning = !isRunning; document.getElementById('toggleText').textContent = isRunning? 'Pause':'Start';
if(isRunning){ startDropping(); lastTs = 0; animationId = requestAnimationFrame(animate); } else { stopDropping(); }
});


document.getElementById('resetBtn2').addEventListener('click', ()=>{
isRunning=false; stopDropping(); document.getElementById('toggleText').textContent='Start'; balls=[]; bins = new Array(BINS).fill(0); drawStatic(); document.getElementById('totalCount').textContent=0;
});


document.getElementById('singleDrop').addEventListener('click', ()=>{ balls.push(new Ball(probability)); if(!isRunning){ requestAnimationFrame(ts=>{ lastTs=0; animate(ts); }); } });


document.getElementById('speedRange').addEventListener('input',(e)=>{ speed = Number(e.target.value); document.getElementById('speedVal').textContent = speed; });
document.getElementById('rowsRange').addEventListener('input',(e)=>{ ROWS = Number(e.target.value); BINS = ROWS+1; document.getElementById('rowsVal').textContent = ROWS; bins = new Array(BINS).fill(0); setupLayout(); drawStatic(); });
document.getElementById('pRange').addEventListener('input',(e)=>{ probability = Number(e.target.value); document.getElementById('pVal').textContent = probability.toFixed(2); drawStatic(); });
document.getElementById('rateRange').addEventListener('input',(e)=>{ dropRate = Number(e.target.value); document.getElementById('rateVal').textContent = dropRate; if(isRunning){ stopDropping(); startDropping(); } });


function startDropping(){
if(dropInterval) clearInterval(dropInterval);
if(dropRate <=0) return;
const ms = 1000 / dropRate;
dropInterval = setInterval(()=>{ if(balls.length < 120) balls.push(new Ball(probability)); }, ms);
}
function stopDropping(){ if(dropInterval){ clearInterval(dropInterval); dropInterval=null; } }


function setupLayout(){ // recompute coords based on canvas width
const cw = canvas.clientWidth;
START_X = cw/2;
SPACING = Math.max(32, Math.min(50, (cw*0.9)/(ROWS+2)));
START_Y = 86; FUNNEL_Y = 26;
BALL_RADIUS = Math.max(5, SPACING*0.16);
PEG_RADIUS = Math.max(3, SPACING*0.09);
bins = new Array(BINS).fill(0);
}


// init
setupLayout(); drawStatic();


// snapshot exporter
document.getElementById('snapshotBtn').addEventListener('click', ()=>{
const link = document.createElement('a'); link.download = 'quincunx-snapshot.png'; link.href = canvas.toDataURL('image/png'); link.click();
});


document.getElementById('exportCsvBtn').addEventListener('click', ()=>{
const rows = ['bin,count']; for(let i=0;i<bins.length;i++){ rows.push(`${i},${bins[i]}`); }
const blob = new Blob([rows.join('\n')],{type:'text/csv'}); const url = URL.createObjectURL(blob);
const a = document.createElement('a'); a.href=url; a.download='quincunx-data.csv'; a.click(); URL.revokeObjectURL(url);
});


// initial values in UI
document.getElementById('pVal').textContent = probability.toFixed(2);
document.getElementById('rowsVal').textContent = ROWS;
document.getElementById('speedVal').textContent = speed;
document.getElementById('rateVal').textContent = dropRate;


</script>
</body>
</html>
